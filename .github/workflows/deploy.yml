# .github/workflows/deploy.yml
name: ðŸš€ Deploy Backend Miracle - HomologaÃ§Ã£o

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deploy to staging'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '24'

jobs:
  # Job 1: Testes e Build
  test-and-build:
    name: ðŸ§ª Test & Build
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci

      - name: ðŸ” Lint Code
        run: npm run lint

      - name: ðŸ—ï¸ Build Project
        run: npm run build

    # - name: ðŸ§ª Run Tests (descomente quando tiver testes)
    #   run: npm test

  # Job 2: Deploy para HomologaÃ§Ã£o (automÃ¡tico)
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    environment:
      name: staging
      url: http://api-homolog.seudominio.com

    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.EC2_STAGING_SSH_KEY }}

      - name: ðŸ“‹ Add Staging EC2 to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.EC2_STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: ðŸš€ Deploy to Staging Server
        run: |
          ssh ${{ secrets.EC2_STAGING_USER }}@${{ secrets.EC2_STAGING_HOST }} << 'EOF'
            set -e
            
            echo "ðŸ”„ Starting deployment to staging..."
            echo "ðŸ“… Deploy time: $(date)"
            
            # Navegar para o diretÃ³rio do projeto
            cd /var/www/backend-homolog
            
            # Backup do .env atual
            cp .env .env.backup || echo "No .env to backup"
            
            # Mostrar informaÃ§Ãµes atuais
            echo "ðŸ“ Current branch: $(git branch --show-current)"
            echo "ðŸ“ Current commit: $(git rev-parse --short HEAD)"
            
            # Pull das Ãºltimas alteraÃ§Ãµes
            git fetch origin
            git reset --hard origin/main
            git clean -fd
            
            # Mostrar novas informaÃ§Ãµes
            echo "ðŸ“ New commit: $(git rev-parse --short HEAD)"
            echo "ðŸ“ Commit message: $(git log -1 --pretty=%B)"
            
            # Restaurar .env
            cp .env.backup .env || echo "No .env backup to restore"
            
            # Instalar dependÃªncias
            echo "ðŸ“¦ Installing dependencies..."
            npm ci --production=false
            
            # Build do projeto
            echo "ðŸ—ï¸ Building project..."
            npm run build
            
            # Criar diretÃ³rio de logs se nÃ£o existir
            mkdir -p logs
            
            # Restart da aplicaÃ§Ã£o com PM2
            echo "ðŸ”„ Restarting application..."
            pm2 reload ecosystem.config.js --only backend-miracle-homolog || pm2 start ecosystem.config.js --only backend-miracle-homolog
            
            # Aguardar a aplicaÃ§Ã£o subir
            echo "â³ Waiting for application to start..."
            sleep 10
            
            # Health check
            echo "ðŸ” Performing health check..."
            if curl -f http://localhost:3001/health; then
              echo "âœ… Staging deployment successful!"
              echo "ðŸŒ Application available at: http://api-homolog.seudominio.com"
            else
              echo "âŒ Health check failed!"
              echo "ðŸ“‹ Recent logs:"
              pm2 logs backend-miracle-homolog --lines 20
              exit 1
            fi
            
            # Mostrar status final
            echo "ðŸ“Š Final status:"
            pm2 status
          EOF

      - name: ðŸ“§ Notify Staging Success
        if: success()
        run: |
          echo "âœ… Staging deployment completed successfully!"
          echo "ðŸŒ Application available at: http://api-homolog.seudominio.com"
          echo "ðŸ“‹ Next steps:"
          echo "   - Test the application"
          echo "   - Check logs if needed"
          echo "   - When ready, create production server"

      - name: ðŸ“§ Notify Staging Failure
        if: failure()
        run: |
          echo "âŒ Staging deployment failed!"
          echo "ðŸ” Check the logs above for details"
          echo "ðŸ’¡ Common issues:"
          echo "   - SSH connection problems"
          echo "   - Build failures"
          echo "   - Health check timeout"
          echo "   - PM2 restart issues"

  # Job 3: Placeholder para produÃ§Ã£o (para o futuro)
  deploy-production-info:
    name: ðŸ“‹ Production Deploy Info
    needs: deploy-staging
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: ðŸ“‹ Production Deploy Instructions
        run: |
          echo "ðŸš§ Production deployment not configured yet"
          echo "ðŸ“‹ To enable production deployment:"
          echo "   1. Create production EC2 instance"
          echo "   2. Configure production secrets:"
          echo "      - EC2_PRODUCTION_SSH_KEY"
          echo "      - EC2_PRODUCTION_HOST"
          echo "      - EC2_PRODUCTION_USER"
          echo "   3. Update workflow to include production job"
          echo "   4. Set up production environment protection"
